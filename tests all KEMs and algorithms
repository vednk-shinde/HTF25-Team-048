#!/bin/bash

# liboqs verification + performance summary script

echo "===== liboqs Verification & Performance Summary ====="

# Optional: enable AVX2 acceleration
export OQS_ENABLE_KEM_AVX2=1

# Arrays of algorithms
KEM_ALGS=(
BIKE-L1 BIKE-L3 BIKE-L5
Classic-McEliece-348864 Classic-McEliece-348864f
Classic-McEliece-460896 Classic-McEliece-460896f
Classic-McEliece-6688128 Classic-McEliece-6688128f
Classic-McEliece-6960119 Classic-McEliece-6960119f
Classic-McEliece-8192128 Classic-McEliece-8192128f
HQC-128 HQC-192 HQC-256
Kyber512 Kyber768 Kyber1024
ML-KEM-512 ML-KEM-768 ML-KEM-1024
NTRU-HPS-2048-509 NTRU-HPS-2048-677
NTRU-HPS-4096-821 NTRU-HPS-4096-1229
NTRU-HRSS-701 NTRU-HRSS-1373
sntrup761
FrodoKEM-640-AES FrodoKEM-640-SHAKE
FrodoKEM-976-AES FrodoKEM-976-SHAKE
FrodoKEM-1344-AES FrodoKEM-1344-SHAKE
)

SIG_ALGS=(
Dilithium2 Dilithium3 Dilithium5
Falcon-512 Falcon-1024
SPHINCS+-shake-128f-robust SPHINCS+-shake-192f-robust SPHINCS+-shake-256f-robust
)

# Initialize results array
RESULTS=()

# Function to test algorithms
test_alg() {
    local type=$1
    local alg=$2
    start=$(date +%s.%N)
    
    if [ "$type" == "KEM" ]; then
        output=$(./tests/test_kem $alg 2>&1)
    else
        output=$(./tests/test_sig $alg 2>&1)
    fi

    end=$(date +%s.%N)
    runtime=$(echo "$end - $start" | bc)

    if echo "$output" | grep -q "shared secrets are equal\|Verification OK"; then
        status="Pass"
    else
        status="Fail"
    fi

    RESULTS+=("$alg|$type|$status|$runtime")
}

# Test KEMs
for alg in "${KEM_ALGS[@]}"; do
    echo "Testing KEM: $alg"
    test_alg "KEM" "$alg"
done

# Test Signatures
for alg in "${SIG_ALGS[@]}"; do
    echo "Testing SIG: $alg"
    test_alg "SIG" "$alg"
done

# Print summary table
echo
echo "===== Verification Summary Table ====="
printf "| %-30s | %-4s | %-5s | %-8s |\n" "Algorithm" "Type" "Status" "Time(s)"
echo "-------------------------------------------------------------------------------"
for r in "${RESULTS[@]}"; do
    IFS='|' read -r alg type status time <<< "$r"
    printf "| %-30s | %-4s | %-5s | %-8.3f |\n" "$alg" "$type" "$status" "$time"
done

echo "===== Verification & Performance Measurement Completed ====="
